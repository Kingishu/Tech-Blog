---
title: "FileStream文件流"
category: "Unity笔记"
section: "数据持久化"
author: "Kingishu"
description: "FileStream文件流相关操作"
---

## 打开或创建指定文件

### 1. 使用 FileStream 构造函数

通过构造函数创建文件流，提供完整的控制选项：

csharp

```
// 创建可读写文件流，允许其他进程读取
FileStream fs = new FileStream(
    Application.persistentDataPath + "/Student/" + filename + ".txt",
    FileMode.OpenOrCreate,
    FileAccess.ReadWrite,
    FileShare.Read
);
```



**参数说明：**

- **路径**：文件在系统中的完整路径
- **打开模式** (FileMode)：
  - `CreateNew`：创建新文件，如果文件已存在则抛出异常
  - `Create`：创建文件，如果文件存在则覆盖
  - `Open`：打开现有文件，如果文件不存在则抛出异常
  - `OpenOrCreate`：打开文件（存在时）或创建新文件（不存在时）
  - `Append`：打开文件并定位到文件末尾，或创建新文件
  - `Truncate`：打开现有文件并立即清空内容
- **访问模式** (FileAccess)：
  - `Read`：只读访问
  - `Write`：只写访问
  - `ReadWrite`：读写访问
- **共享权限** (FileShare)：
  - `None`：完全禁止共享
  - `Read`：允许其他进程读取
  - `Write`：允许其他进程写入
  - `ReadWrite`：允许其他进程读写

### 2. 使用 File.Open 方法

csharp

```
// 以只读方式打开文件
FileStream fs = File.Open(
    Application.persistentDataPath + "/Student/" + filename + ".txt",
    FileMode.Open,
    FileAccess.Read
);
```



此方法与构造函数参数相同，提供更简洁的语法。

### 3. 使用 File.Create 方法

csharp

```
// 创建文件并指定缓冲区大小
FileStream fs = File.Create(
    Application.persistentDataPath + "/Student.txt", 
    2048  // 缓冲区大小(字节)
);
```



**参数说明：**

- **路径**：要创建的文件路径
- **缓冲区大小**：文件流的缓冲区大小，适当设置可优化I/O性能

## 写入文件操作

FileStream 以字节为单位操作文件，需要将数据转换为字节数组后写入。

### 写入基本数据类型

csharp

```
// 写入整数
int number = 100;
byte[] intBytes = BitConverter.GetBytes(number);
fs.Write(intBytes, 0, 4);

// 写入浮点数
float score = 95.5f;
byte[] floatBytes = BitConverter.GetBytes(score);
fs.Write(floatBytes, 0, 4);

// 写入布尔值
bool isPass = true;
byte[] boolBytes = BitConverter.GetBytes(isPass);
fs.Write(boolBytes, 0, 1);
```



**Write 方法参数：**

- **buffer**：要写入的字节数组
- **offset**：从字节数组的哪个位置开始写入
- **count**：写入的字节数量

### 写入字符串类型

字符串长度可变，需要特殊处理：

csharp

```
string name = "秦豪凯";
byte[] stringBytes = Encoding.UTF8.GetBytes(name);

// 先写入字符串长度（4字节整数）
byte[] lengthBytes = BitConverter.GetBytes(stringBytes.Length);
fs.Write(lengthBytes, 0, 4);

// 再写入字符串内容
fs.Write(stringBytes, 0, stringBytes.Length);
```



**写入顺序：**

1. 将字符串转换为字节数组
2. 写入字节数组长度（4字节）
3. 写入字符串字节数据

## 读取文件操作

读取时需要按照写入时的格式和顺序进行解析：

csharp

```
using (FileStream fs = File.Open(
    Application.persistentDataPath + "/Student/" + filename + ".txt",
    FileMode.Open, 
    FileAccess.Read))
{
    byte[] fileBytes = new byte[fs.Length];
    fs.Read(fileBytes, 0, fileBytes.Length);
    
    int index = 0;
    Student student = new Student();
    
    // 读取ID（4字节整数）
    student.id = BitConverter.ToInt32(fileBytes, index);
    index += 4;
    
    // 读取字符串长度（4字节整数）
    int nameLength = BitConverter.ToInt32(fileBytes, index);
    index += 4;
    
    // 读取字符串内容
    student.name = Encoding.UTF8.GetString(fileBytes, index, nameLength);
    index += nameLength;
    
    // 读取分数（4字节浮点数）
    student.score = BitConverter.ToSingle(fileBytes, index);
    index += 4;
    
    // 读取是否通过（1字节布尔值）
    student.pass = BitConverter.ToBoolean(fileBytes, index);
    
    return student;
}
```



## 最佳实践

1. **使用 using 语句**确保资源正确释放
2. **异常处理**：捕获可能出现的 IOException 等异常
3. **缓冲区大小**：根据文件大小合理设置缓冲区
4. **编码一致性**：读写时使用相同的字符编码

csharp

```
try
{
    using (FileStream fs = new FileStream(path, FileMode.OpenOrCreate, FileAccess.ReadWrite))
    {
        // 文件操作代码
    }
}
catch (IOException ex)
{
    Debug.LogError($"文件操作失败: {ex.Message}");
}
```



通过以上方法，您可以高效地进行文件读写操作，确保数据的完整性和一致性。